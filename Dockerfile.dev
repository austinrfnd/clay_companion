# frozen_string_literal: true

##
# Dockerfile.dev
#
# Development Docker image for Clay Companion Rails application.
# Built on Ruby 3.3.0 Alpine with PostgreSQL, ImageMagick, and vips for image processing.
#
# Usage:
#   docker-compose build
#   docker-compose up

FROM ruby:3.4-alpine

# Set Rails environment
ENV RAILS_ENV=development \
    BUNDLE_PATH=/usr/local/bundle \
    BUNDLE_JOBS=4 \
    BUNDLE_RETRY=3

# Install system dependencies
# - build-base: C compiler and build tools
# - postgresql-dev: PostgreSQL client libraries
# - nodejs, npm: JavaScript runtime for asset pipeline
# - git: Version control (needed by some gems)
# - imagemagick: Image processing for Active Storage
# - vips, vips-dev: Fast image processing library
# - tzdata: Timezone data
# - libyaml-dev: Required for psych gem (YAML parser)
RUN apk add --no-cache \
    build-base \
    postgresql-dev \
    postgresql-client \
    nodejs \
    npm \
    git \
    imagemagick \
    vips \
    vips-dev \
    tzdata \
    yaml-dev

# Create application directory
WORKDIR /app

# Install bundler version 2.5.6
RUN gem install bundler:2.5.6

# Copy Gemfile and Gemfile.lock (when they exist)
# This layer is cached unless Gemfile changes
COPY Gemfile* ./

# Install gems (skip this if Gemfile doesn't exist yet)
# We'll run this after Rails is initialized
RUN if [ -f Gemfile ]; then bundle install; fi

# Copy package.json and package-lock.json (when they exist)
# Use wildcard with optional flag to prevent failure if files don't exist
COPY package*.json* ./

# Install npm packages (skip this if package.json doesn't exist yet)
RUN if [ -f package.json ]; then npm install; fi

# Copy application code
# This is done last so code changes don't invalidate earlier layers
COPY . .

# Expose port 3000 for Rails server
EXPOSE 3000

# Default command: start Rails server
# This can be overridden by docker-compose.yml
CMD ["bundle", "exec", "rails", "server", "-b", "0.0.0.0"]
